
<html>
<head>
  <meta charset="UTF-8">
  <title>OffscreenCanvas Example</title>
  <script>
    // const worker = new Worker("worker.js");
    const worker = new Worker('worker.js', { type: 'module' });

    let htmlCanvas;
    let offscreenCanvas ;
    // const offscreenCanvas = htmlCanvas.transferControlToOffscreen();
    // function onClick() {
    //
    //   const f = document.getElementById("in-file").files[0];
    //   console.log("üì§ Sending file to worker:", f);
    //
    //   worker.postMessage([ f ]);
    // }

    window.addEventListener('DOMContentLoaded', () => {
      // Now HTML elements are guaranteed loaded

      document.getElementById('dcp-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        console.log('üì§ GOT DCP file:', file);

        if (file) {
          console.log('üì§ Sending DCP file to worker:', file);
          worker.postMessage({ type: 'dcp', file: file });
        }
      });
    });

    function onClick() {

      const fileList = document.getElementById("in-file").files;
      // console.log("üì§ Sending files to worker:", fileList);

      // const files = Array.from(fileList); // convert FileList to array
      const files = [fileList[0]]; // pick the first file
      //
      htmlCanvas = document.getElementById('myCanvas');
      // const offscreenCanvas = htmlCanvas.transferControlToOffscreen();
       offscreenCanvas = htmlCanvas.transferControlToOffscreen();

      worker.postMessage({ files, canvas: offscreenCanvas }, [offscreenCanvas]);
      // worker.postMessage({ files });
    }

    //multiple files
    worker.onmessage = (e) => {
      const data = e.data;

      if (data.type === "log") {
        const logDiv = document.getElementById('worker-logs');
        if (logDiv) {
          const p = document.createElement('p');
          p.textContent = data.log;
          logDiv.appendChild(p);
        }
      }
      if (data.result && Array.isArray(data.result)) {
        console.log("‚úÖ Results from worker:");
        data.result.forEach(r => {
          if (r.error) {
            console.error(`‚ùå ${r.file}: ${r.error}`);
          } else {
            console.log(`‚úÖ ${r.file}: ${r.result}`);
          }
        });
      } else if (data.log) {
        // console.log("üì• Worker log:", data.log);
      } else if (data.error) {
        console.error("‚ùå Worker error:", data.error);
      } else {
        console.log("üì® Worker message:", data);
      }
    };
  </script>
</head>
<body>
<!--<input type="file" id="in-file" />-->
<label>üì∏ Select Images:</label>
<input type="file" id="in-file" multiple />

<label>üé® Load DCP Profile:</label>
<input type="file" id="dcp-file" />

<!-- Exposure slider -->
<div>
  <label for="exposure-slider">Exposure:</label>
  <input type="range" id="exposure-slider" min="-5" max="5" step="0.1" value="0">
  <span id="exposure-value">0</span>
</div>

<!-- Contrast slider -->
<div>
  <label for="contrast-slider">Contrast:</label>
  <input type="range" id="contrast-slider" min="-100" max="100" step="1" value="0">
  <span id="contrast-value">0</span>
</div>

<input type="button" onClick="onClick()" value="ok" />
<div id="worker-logs" style="font-family: monospace; padding: 10px; border: 1px solid black; background: #f9f9f9; color: #333; min-height: 50px;"></div>

<canvas id="myCanvas" width="800" height="600"></canvas>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

<script type="module">
  import init from './build/dng_example.js';

  init().then((Module) => {
    console.log("‚úÖ WASM loaded", Module);
    window.dngModule = Module; // optional: save globally
  }).catch((err) => {
    console.error("‚ùå Failed to initialize WASM", err);
  });


  // document.getElementById('exposure-slider').addEventListener('input', function () {
  //   const exposureValue = parseFloat(this.value); // **NEW LINE: Get the slider value as a number**
  //   document.getElementById('exposure-value').textContent = exposureValue; // **NEW LINE: Update the displayed exposure value**
  //
  //   // **SEND UPDATED EXPOSURE TO WORKER**
  //   const fileList = document.getElementById("in-file").files;
  //   const files = [fileList[0]]; // Assuming only one file is uploaded
  //
  //   // Send updated exposure to the worker for re-rendering
  //   worker.postMessage({
  //     files,
  //     exposure: exposureValue, // **SEND EXPOSURE VALUE HERE**
  //     type: 'image_processing' // Indicates that image processing is triggered again
  //   });
  // });

  // let sliderTimeout;
  //
  // document.getElementById('exposure-slider').addEventListener('input', function () {
  //   // Clear the previous timeout if the slider is being moved again
  //   clearTimeout(sliderTimeout);
  //
  //   const exposureValue = parseFloat(this.value); // Get the slider value as a number
  //   document.getElementById('exposure-value').textContent = exposureValue; // Update the displayed exposure value
  //
  //   // Set a new timeout to trigger after 0.05 seconds if the slider value hasn't changed
  //   sliderTimeout = setTimeout(function () {
  //     const fileList = document.getElementById("in-file").files;
  //     const files = [fileList[0]]; // Assuming only one file is uploaded
  //
  //     // Send updated exposure to the worker for re-rendering
  //     worker.postMessage({
  //       files,
  //       exposure: exposureValue, // Send exposure value here
  //       type: 'image_processing' // Indicates that image processing is triggered again
  //     });
  //   }, 50); // Wait for 50ms (0.05 seconds) after the last input
  // });

  // import throttle from 'lodash/throttle';

  // Throttled function that sends data to the worker
    const throttledSendToWorker = _.throttle(function (exposureValue) {
    const fileList = document.getElementById("in-file").files;
    const files = [fileList[0]];

    worker.postMessage({
    files,
    exposure: exposureValue,
    type: 'image_processing'
  });
  }, 50);

  // Throttled function that sends data to the worker
    const throttledSendToWorkerContrast = _.throttle(function (contrastValue) {
    const fileList = document.getElementById("in-file").files;
    const files = [fileList[0]];

    worker.postMessage({
    files,
      contrast: contrastValue,
    type: 'image_processing'
  });
  }, 50);

  document.getElementById('exposure-slider').addEventListener('input', function () {
    const exposureValue = parseFloat(this.value);
    document.getElementById('exposure-value').textContent = exposureValue;
    throttledSendToWorker(exposureValue);
  });

  document.getElementById('contrast-slider').addEventListener('input', function () {
    const contrastValue = parseFloat(this.value);
    document.getElementById('contrast-value').textContent = contrastValue;
    throttledSendToWorkerContrast(contrastValue);
  });


</script>

</body>
</html>
