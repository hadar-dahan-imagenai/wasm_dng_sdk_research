<html>
<head>
  <meta charset="UTF-8">
  <title>OffscreenCanvas Example</title>
  <script>
    // const worker = new Worker("worker.js");
    const worker = new Worker('worker.js', { type: 'module' });

    // function onClick() {
    //
    //   const f = document.getElementById("in-file").files[0];
    //   console.log("ğŸ“¤ Sending file to worker:", f);
    //
    //   worker.postMessage([ f ]);
    // }

    window.addEventListener('DOMContentLoaded', () => {
      // Now HTML elements are guaranteed loaded

      document.getElementById('dcp-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        console.log('ğŸ“¤ GOT DCP file:', file);

        if (file) {
          console.log('ğŸ“¤ Sending DCP file to worker:', file);
          worker.postMessage({ type: 'dcp', file: file });
        }
      });
    });


    function onClick() {

      const fileList = document.getElementById("in-file").files;
      // console.log("ğŸ“¤ Sending files to worker:", fileList);

      // const files = Array.from(fileList); // convert FileList to array
      const files = [fileList[0]]; // pick the first file

      const htmlCanvas = document.getElementById('myCanvas');
      const offscreenCanvas = htmlCanvas.transferControlToOffscreen();

      worker.postMessage({ files, canvas: offscreenCanvas }, [offscreenCanvas]);
      // worker.postMessage({ files });
    }

    //multiple files
    worker.onmessage = (e) => {
      const data = e.data;

        // console.log("worker data.type", data.type)
      if (data.type === "log") {
        const logDiv = document.getElementById('worker-logs');
        if (logDiv) {
          // console.log("logDiv", logDiv)

          const p = document.createElement('p');
          p.textContent = data.log;
          logDiv.appendChild(p);
          // console.log("Adding message:", data.log);
          // console.log("p element:", p);
          // console.log("logDiv before append:", logDiv.innerHTML);
        }
      }
      if (data.result && Array.isArray(data.result)) {
        console.log("âœ… Results from worker:");
        data.result.forEach(r => {
          if (r.error) {
            console.error(`âŒ ${r.file}: ${r.error}`);
          } else {
            console.log(`âœ… ${r.file}: ${r.result}`);
          }
        });
      } else if (data.log) {
        // console.log("ğŸ“¥ Worker log:", data.log);
      } else if (data.error) {
        console.error("âŒ Worker error:", data.error);
      } else {
        console.log("ğŸ“¨ Worker message:", data);
      }
    };


    //one file
    // ğŸ”¥ Receive message from worker
    // worker.onmessage = (e) => {
    //   const data = e.data;
    //
    //   if (data.result) {
    //     console.log("âœ… Main thread received result:", data.result);
    //     alert("File read result:\n" + data.result);
    //   } else if (data.log) {
    //     console.log("ğŸ“¥ Worker log:", data.log);
    //   } else if (data.error) {
    //     console.error("âŒ Error from worker:", data.error);
    //     alert("Worker Error: " + data.error);
    //   } else {
    //     console.log("ğŸ“¨ Worker sent unknown message:", data);
    //   }
    // };

  </script>
</head>
<body>
<!--<input type="file" id="in-file" />-->
<label>ğŸ“¸ Select Images:</label>
<input type="file" id="in-file" multiple />

<label>ğŸ¨ Load DCP Profile:</label>
<input type="file" id="dcp-file" />


<input type="button" onClick="onClick()" value="ok" />
<div id="worker-logs" style="font-family: monospace; padding: 10px; border: 1px solid black; background: #f9f9f9; color: #333; min-height: 50px;"></div>

<canvas id="myCanvas" width="800" height="600"></canvas>

<!--<script src="build/dng_example.js"></script> &lt;!&ndash; Your compiled WASM glue code &ndash;&gt;-->
<script type="module">
  import init from './build/dng_example.js';

  init().then((Module) => {
    console.log("âœ… WASM loaded", Module);
    window.dngModule = Module; // optional: save globally
  }).catch((err) => {
    console.error("âŒ Failed to initialize WASM", err);
  });
</script>


</body>
</html>
